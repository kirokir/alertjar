<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="A lightweight PWA for personal finance and diary tracking with cloud sync.">
<title>Alert Jar</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #2563eb; --primary-dark: #1e40af; --success: #10b981; --danger: #ef4444;
  --warning: #f59e0b; --info: #3b82f6; --bg: #ffffff; --bg-secondary: #f3f4f6;
  --text: #1f2937; --text-secondary: #6b7280; --border: #e5e7eb; --shadow: rgba(0, 0, 0, 0.1);
}
html[data-theme="dark"] {
  --primary: #3b82f6; --primary-dark: #2563eb; --bg: #111827; --bg-secondary: #1f2937;
  --text: #f3f4f6; --text-secondary: #9ca3af; --border: #374151; --shadow: rgba(0, 0, 0, 0.2);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow-x: hidden; transition: background-color 0.2s, color 0.2s; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
header { background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px var(--shadow); }
.header-content { display: flex; justify-content: space-between; align-items: center; padding: 1rem; }
.header-actions { display: flex; align-items: center; gap: 0.5rem; }
h1 { font-size: 1.5rem; font-weight: 600; }
.icon-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; color: var(--text-secondary); transition: background 0.2s; }
.icon-btn:hover { background: var(--bg-secondary); }
nav { display: flex; gap: 0; overflow-x: auto; border-bottom: 1px solid var(--border); }
.tab-btn { flex: 1; min-width: 80px; padding: 0.75rem 0.5rem; border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab-btn svg { width: 20px; height: 20px; }
.tab-btn:hover { background: var(--bg-secondary); } 
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
main { min-height: calc(100vh - 150px); padding: 1rem 0; }
.tab-content { display: none; } 
.tab-content.active { display: block; }
.sub-tab-nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); }
.sub-tab-btn { padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.2s; }
.sub-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 500; }
.sub-tab-content { display: none; } 
.sub-tab-content.active { display: block; }
.card { background: var(--bg); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px var(--shadow); }
.card h2 { font-size: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;}
.card h3 { font-size: 1rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.05em; margin-bottom: 1rem; }
.record-btn { width: 64px; height: 64px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 1rem auto; transition: all 0.2s; box-shadow: 0 2px 8px var(--shadow); }
.record-btn:hover { background: var(--primary-dark); transform: scale(1.05); } 
.record-btn.recording { background: var(--danger); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.transcription { min-height: 60px; max-height: 120px; overflow-y: auto; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.375rem; margin: 1rem 0; font-size: 0.875rem; color: var(--text-secondary); }
.transcription.active { color: var(--text); border: 1px solid var(--primary); }
.input-group { margin-bottom: 1rem; } 
.input-group label { display: block; font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500;}
input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.375rem; font-size: 0.875rem; font-family: inherit; background-color: var(--bg); color: var(--text); }
textarea { min-height: 80px; resize: vertical; }
.btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 0.5rem; text-align: center;}
.btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
.btn-primary { background: var(--primary); color: white; } 
.btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
.btn-secondary { background: var(--bg-secondary); color: var(--text); } 
.btn-secondary:hover { background: var(--border); }
.btn-danger { background: var(--danger); color: white; } 
.btn-small { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
.entry { padding: 1rem; border-bottom: 1px solid var(--border); } 
.entry:last-child { border-bottom: none; }
.entry-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.entry-time { font-size: 0.75rem; color: var(--text-secondary); }
.entry-amount { font-size: 1.125rem; font-weight: 600; } 
.entry-amount.asset { color: var(--success); } 
.entry-amount.liability { color: var(--danger); }
.entry-text { margin: 0.5rem 0; font-size: 0.875rem; word-break: break-word; }
.entry-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
.time-block-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
.time-block-table th, .time-block-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
.time-block-table th { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
.time-block-table td { font-size: 0.875rem; vertical-align: middle; }
.time-block-table .check-cell { width: 40px; text-align: center; }
.time-block-table .check-cell button { background: none; border: 2px solid var(--border); width: 24px; height: 24px; border-radius: 50%; cursor: pointer; color: var(--success); transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.time-block-table .check-cell button:hover { border-color: var(--success); }
.time-block-table tr.missed { opacity: 0.6; text-decoration: line-through; }
.profile-card { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;}
.profile-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
.profile-info h3 { margin: 0; font-size: 1.25rem;} 
.profile-info p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }
.status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 1rem; font-weight: 500; }
.status-indicator.connected { color: var(--success); background-color: rgba(16, 185, 129, 0.1); }
.status-indicator.disconnected { color: var(--danger); background-color: rgba(239, 68, 68, 0.1); }
.settings-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem 0; border-bottom: 1px solid var(--border); }
.settings-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
#toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; }
.toast { background: var(--text); color: white; padding: 1rem 1.5rem; border-radius: 0.375rem; box-shadow: 0 4px 12px var(--shadow); margin-top: 0.5rem; animation: slideIn 0.3s; }
@keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.toast.success { background: var(--success); } 
.toast.error { background: var(--danger); }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
.modal.active { display: flex; } 
.modal-content { background: var(--bg); border-radius: 0.5rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 1.5rem; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; color: var(--text-secondary); }
.hidden { display: none !important; }
.empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
.warning-banner { background: var(--warning); color: #78350f; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.calendar-nav { display: flex; gap: 0.5rem; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
.calendar-day-header { padding: 0.5rem; text-align: center; font-weight: 600; font-size: 0.75rem; background: var(--bg-secondary); }
.calendar-day { min-height: 80px; padding: 0.5rem; background: var(--bg); cursor: pointer; transition: background 0.2s; }
.calendar-day:hover { background: var(--bg-secondary); }
.calendar-day.today { background: rgba(37, 99, 235, 0.1); font-weight: 700; color: var(--primary); }
.calendar-day.other-month { opacity: 0.3; }
.chart-container { position: relative; height: 400px; margin: 1rem 0; }
.graph-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
.graph-period-selector { display: flex; gap: 0.5rem; }
.tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; }
.tag { padding: 0.25rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 1rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
.tag:hover { background: var(--primary); color: white; }
.tag.active { background: var(--primary); color: white; }
</style>
</head>
<body>

<header>
  <div class="header-content">
    <h1>Alert Jar</h1>
    <div class="header-actions">
      <button id="theme-toggle" class="icon-btn">🌙</button>
      <button id="help-btn" class="icon-btn">❓</button>
    </div>
  </div>
  <nav>
    <button class="tab-btn active" data-tab="ledger">
      <span>💰</span><span>Ledger</span>
    </button>
    <button class="tab-btn" data-tab="diary">
      <span>📔</span><span>Diary</span>
    </button>
    <button class="tab-btn" data-tab="calendar">
      <span>📅</span><span>Calendar</span>
    </button>
    <button class="tab-btn" data-tab="graphs">
      <span>📊</span><span>Graphs</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <span>⚙️</span><span>Settings</span>
    </button>
  </nav>
</header>

<main class="container">
  <div id="ledger-tab" class="tab-content active">
    <div class="card">
      <div class="sub-tab-nav">
        <button class="sub-tab-btn active" data-subtab="assets">Assets</button>
        <button class="sub-tab-btn" data-subtab="liabilities">Liabilities</button>
      </div>
      
      <div id="assets-subtab" class="sub-tab-content active">
        <h2>Assets</h2>
        <div id="speech-warning-asset" class="warning-banner hidden">Speech recognition active</div>
        <button class="record-btn" id="record-asset">🎤</button>
        <div id="transcription-asset" class="transcription">Tap microphone or type below</div>
        <div class="input-group">
          <input type="text" id="manual-asset" placeholder="E.g., Client payment 69000 rupees">
        </div>
        <button class="btn btn-primary" id="add-asset-btn">Add Asset</button>
        <div id="entries-asset" class="entries"></div>
      </div>
      
      <div id="liabilities-subtab" class="sub-tab-content">
        <h2>Liabilities</h2>
        <div id="speech-warning-liability" class="warning-banner hidden">Speech recognition active</div>
        <button class="record-btn" id="record-liability">🎤</button>
        <div id="transcription-liability" class="transcription">Tap microphone or type below</div>
        <div class="input-group">
          <input type="text" id="manual-liability" placeholder="E.g., Dinner with friends 700">
        </div>
        <button class="btn btn-primary" id="add-liability-btn">Add Liability</button>
        <div id="entries-liability" class="entries"></div>
      </div>
    </div>
  </div>

  <div id="diary-tab" class="tab-content">
    <div class="card">
      <div class="sub-tab-nav">
        <button class="sub-tab-btn active" data-subtab="journal">Journal</button>
        <button class="sub-tab-btn" data-subtab="todo">To-Do</button>
      </div>
      
      <div id="journal-subtab" class="sub-tab-content active">
        <h2>Journal</h2>
        <div id="speech-warning-diary" class="warning-banner hidden">Speech recognition active</div>
        <button class="record-btn" id="record-diary">🎤</button>
        <div id="transcription-diary" class="transcription">Tap microphone or type below</div>
        <div class="input-group">
          <textarea id="manual-diary" placeholder="Write your thoughts..."></textarea>
        </div>
        <button class="btn btn-primary" id="add-diary-btn">Save Entry</button>
        <div class="input-group">
          <input type="text" id="search-diary" placeholder="Search...">
        </div>
        <div id="tags-diary" class="tags"></div>
        <div id="entries-diary" class="entries"></div>
      </div>
      
      <div id="todo-subtab" class="sub-tab-content">
        <h2>Time-Blocked Tasks</h2>
        <div class="input-group">
          <label>From</label>
          <input type="time" id="todo-from">
        </div>
        <div class="input-group">
          <label>To</label>
          <input type="time" id="todo-to">
        </div>
        <div class="input-group">
          <label>Action</label>
          <input type="text" id="todo-action" placeholder="Task description">
        </div>
        <button class="btn btn-primary" id="add-todo-btn">Add Task</button>
        <div id="time-block-list"></div>
      </div>
    </div>
  </div>

  <div id="calendar-tab" class="tab-content">
    <div class="card">
      <div class="calendar-header">
        <h2 id="calendar-month">January 2025</h2>
        <div class="calendar-nav">
          <button id="prev-month" class="btn btn-secondary btn-small">‹</button>
          <button id="today-btn" class="btn btn-secondary btn-small">Today</button>
          <button id="next-month" class="btn btn-secondary btn-small">›</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </div>
  </div>

  <div id="graphs-tab" class="tab-content">
    <div class="card">
      <h2>Financial Distribution</h2>
      <div class="graph-controls">
        <div class="graph-period-selector">
          <button class="btn btn-secondary btn-small" data-period="daily">Daily</button>
          <button class="btn btn-secondary btn-small active" data-period="monthly">Monthly</button>
          <button class="btn btn-secondary btn-small" data-period="yearly">Yearly</button>
        </div>
        <button id="download-chart" class="btn btn-primary btn-small">Download</button>
      </div>
      <div class="chart-container">
        <canvas id="distribution-chart"></canvas>
      </div>
    </div>
  </div>

  <div id="settings-tab" class="tab-content">
    <div class="card">
      <h3>👤 Profile</h3>
      <div id="google-sign-in-prompt">
        <p>Sign in to sync your data across devices</p>
        <button id="google-connect-btn" class="btn btn-primary">Connect with Google</button>
      </div>
      <div id="user-profile-card" class="profile-card hidden">
        <img id="user-avatar" class="profile-avatar" src="" alt="Avatar">
        <div class="profile-info">
          <h3 id="user-name">User</h3>
          <p id="user-email">email@example.com</p>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3>🔐 Account</h3>
      <div class="settings-group">
        <div class="settings-row">
          <label>Cloud Status</label>
          <div id="drive-status" class="status-indicator disconnected">
            <span>Disconnected</span>
          </div>
        </div>
        <button id="google-disconnect-btn" class="btn btn-secondary hidden">Sign Out</button>
      </div>
    </div>
    
    <div class="card">
      <h3>💾 Data</h3>
      <div class="settings-group">
        <button id="export-json" class="btn btn-secondary">Export JSON</button>
        <button id="export-csv" class="btn btn-secondary">Export CSV</button>
        <label for="import-json" class="btn btn-secondary">Import JSON</label>
        <input type="file" id="import-json" accept=".json" class="hidden">
        <button id="clear-data-btn" class="btn btn-danger" disabled>Delete All Data</button>
      </div>
    </div>
  </div>
</main>

<div id="toast-container"></div>

<div id="help-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Help</h2>
      <button class="modal-close">×</button>
    </div>
    <div>
      <h3>Features</h3>
      <p>Track assets, liabilities, journal entries, and time-blocked tasks.</p>
      <p>All data syncs to Supabase cloud when signed in.</p>
    </div>
  </div>
</div>

<div id="day-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="day-modal-title">Day Details</h2>
      <button class="modal-close">×</button>
    </div>
    <div id="day-modal-content"></div>
  </div>
</div>

<script>
'use strict';

const SUPABASE_URL = 'https://lgqpqmpwgndxmvevsluj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxncXBxbXB3Z25keG12ZXZzbHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTc5MTgsImV4cCI6MjA3NTU5MzkxOH0.fIEcIady288ibJCRADISGUcStN1Kuwmry-5rEgy9X_w';

let supabase, chartInstance, recognition;
let isRecording = false;
let currentRecordingType = null;
let transcriptBuffer = '';
let currentCalendarMonth = new Date();

const uuid = () => crypto.randomUUID();
const getLocalDate = (date = new Date()) => date.toISOString().split('T')[0];
const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
const formatDateTime = (timestamp) => new Date(timestamp).toLocaleString();
const sanitize = (str) => String(str).replace(/[<>]/g, '');

function parseAmount(text) {
  const match = text.match(/\d+(\.\d+)?k?/i);
  if (!match) return null;
  let num = parseFloat(match[0].replace(/k/i, ''));
  if (match[0].toLowerCase().includes('k')) num *= 1000;
  return num > 0 ? num : null;
}

function extractTags(text) {
  const words = text.toLowerCase().split(/\s+/);
  const tags = [];
  const keywords = ['food', 'rent', 'salary', 'client', 'transport', 'shopping'];
  keywords.forEach(kw => {
    if (text.toLowerCase().includes(kw)) tags.push(kw);
  });
  return tags.slice(0, 5);
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

async function initSupabase() {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      updateUIAfterAuth(session.user);
      refreshAll();
    } else if (event === 'SIGNED_OUT') {
      updateUIAfterSignOut();
    }
  });
  
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    updateUIAfterAuth(session.user);
  }
}

async function saveEntry(entry) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    showToast('Please sign in first', 'error');
    return;
  }
  
  const { error } = await supabase.from('entries').insert({
    ...entry,
    user_id: user.id
  });
  
  if (error) throw error;
}

async function getEntries(filters = {}) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return [];
  
  let query = supabase.from('entries').select('*').eq('user_id', user.id);
  
  if (filters.type) query = query.eq('type', filters.type);
  if (filters.date) query = query.eq('date', filters.date);
  
  const { data, error } = await query.order('timestamp', { ascending: false });
  if (error) throw error;
  
  return data || [];
}

async function deleteEntry(id) {
  const { error } = await supabase.from('entries').delete().eq('id', id);
  if (error) throw error;
}

function initSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    console.warn('Speech recognition not supported');
    return;
  }
  
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  
  recognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        transcriptBuffer += event.results[i][0].transcript + ' ';
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    
    if (currentRecordingType) {
      const input = document.getElementById(`manual-${currentRecordingType}`);
      const display = document.getElementById(`transcription-${currentRecordingType}`);
      if (input) input.value = transcriptBuffer + interim;
      if (display) display.textContent = (transcriptBuffer + interim) || 'Listening...';
    }
  };
  
  recognition.onerror = () => stopRecording();
  recognition.onend = () => {
    if (isRecording) {
      try { recognition.start(); } catch(e) { stopRecording(); }
    }
  };
}

function startRecording(type) {
  if (!recognition) {
    showToast('Speech recognition not available', 'error');
    return;
  }
  
  currentRecordingType = type;
  isRecording = true;
  transcriptBuffer = '';
  
  const btn = document.getElementById(`record-${type}`);
  const warning = document.getElementById(`speech-warning-${type}`);
  const display = document.getElementById(`transcription-${type}`);
  
  if (btn) btn.classList.add('recording');
  if (warning) warning.classList.remove('hidden');
  if (display) display.classList.add('active');
  
  try {
    recognition.start();
  } catch(e) {
    showToast('Failed to start recording', 'error');
    stopRecording();
  }
}

function stopRecording() {
  if (!isRecording) return;
  
  isRecording = false;
  if (recognition) {
    try { recognition.stop(); } catch(e) {}
  }
  
  if (currentRecordingType) {
    const btn = document.getElementById(`record-${currentRecordingType}`);
    const warning = document.getElementById(`speech-warning-${currentRecordingType}`);
    const display = document.getElementById(`transcription-${currentRecordingType}`);
    
    if (btn) btn.classList.remove('recording');
    if (warning) warning.classList.add('hidden');
    if (display) display.classList.remove('active');
  }
  
  transcriptBuffer = '';
  currentRecordingType = null;
}

async function addEntry(type, text) {
  if (!text.trim()) {
    showToast('Please enter some text', 'error');
    return;
  }
  
  const amount = parseAmount(text);
  if ((type === 'asset' || type === 'liability') && !amount) {
    showToast('Could not detect amount', 'error');
    return;
  }
  
  const entry = {
    id: uuid(),
    type,
    date: getLocalDate(),
    timestamp: Date.now(),
    text,
    amount,
    tags: extractTags(text)
  };
  
  try {
    await saveEntry(entry);
    showToast('Entry saved!', 'success');
    document.getElementById(`manual-${type}`).value = '';
    document.getElementById(`transcription-${type}`).textContent = 'Tap microphone or type below';
    await refreshAll();
  } catch (error) {
    console.error(error);
    showToast('Failed to save', 'error');
  }
}

function renderEntries(type, entries) {
  const container = document.getElementById(`entries-${type}`);
  if (!container) return;
  
  if (entries.length === 0) {
    container.innerHTML = '<div class="empty-state">No entries yet. Sign in to start tracking!</div>';
    return;
  }
  
  container.innerHTML = entries.map(entry => `
    <div class="entry" data-id="${entry.id}">
      <div class="entry-header">
        <div class="entry-time">${formatDateTime(entry.timestamp)}</div>
        ${entry.amount ? `<div class="entry-amount ${type}">${formatCurrency(entry.amount)}</div>` : ''}
      </div>
      <div class="entry-text">${sanitize(entry.text)}</div>
      <div class="entry-actions">
        <button class="btn btn-danger btn-small delete-entry-btn">Delete</button>
      </div>
    </div>
  `).join('');
}

async function addDiaryEntry(text) {
  if (!text.trim()) {
    showToast('Please write something', 'error');
    return;
  }
  
  const entry = {
    id: uuid(),
    type: 'diary',
    date: getLocalDate(),
    timestamp: Date.now(),
    text,
    tags: extractTags(text)
  };
  
  try {
    await saveEntry(entry);
    showToast('Diary entry saved!', 'success');
    document.getElementById('manual-diary').value = '';
    document.getElementById('transcription-diary').textContent = 'Tap microphone or type below';
    await refreshAll();
  } catch (error) {
    console.error(error);
    showToast('Failed to save', 'error');
  }
}

function renderDiaryEntries(entries) {
  const container = document.getElementById('entries-diary');
  if (!container) return;
  
  if (entries.length === 0) {
    container.innerHTML = '<div class="empty-state">No journal entries yet.</div>';
    return;
  }
  
  container.innerHTML = entries.map(entry => `
    <div class="entry" data-id="${entry.id}">
      <div class="entry-header">
        <div class="entry-time">${formatDateTime(entry.timestamp)}</div>
      </div>
      <div class="entry-text">${sanitize(entry.text)}</div>
      <div class="entry-actions">
        <button class="btn btn-danger btn-small delete-entry-btn">Delete</button>
      </div>
    </div>
  `).join('');
}

function renderDiaryTags(entries) {
  const container = document.getElementById('tags-diary');
  if (!container) return;
  
  const allTags = entries.flatMap(e => e.tags || []);
  const tagCounts = {};
  allTags.forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
  
  container.innerHTML = Object.entries(tagCounts)
    .sort((a, b) => b[1] - a[1])
    .map(([tag, count]) => `<span class="tag" data-tag="${tag}">${tag} (${count})</span>`)
    .join('');
}

async function addTodo() {
  const from = document.getElementById('todo-from').value;
  const to = document.getElementById('todo-to').value;
  const action = document.getElementById('todo-action').value.trim();
  
  if (!from || !to || !action) {
    showToast('Please fill all fields', 'error');
    return;
  }
  
  if (to <= from) {
    showToast('End time must be after start time', 'error');
    return;
  }
  
  const entry = {
    id: uuid(),
    type: 'todo',
    date: getLocalDate(),
    timestamp: Date.now(),
    text: action,
    todo_meta: { status: 'pending', from, to, isTimeBlocked: true }
  };
  
  try {
    await saveEntry(entry);
    showToast('Task added!', 'success');
    document.getElementById('todo-from').value = '';
    document.getElementById('todo-to').value = '';
    document.getElementById('todo-action').value = '';
    await refreshAll();
  } catch (error) {
    console.error(error);
    showToast('Failed to add task', 'error');
  }
}

function renderTodos(todos) {
  const container = document.getElementById('time-block-list');
  if (!container) return;
  
  if (todos.length === 0) {
    container.innerHTML = '<p class="empty-state">No tasks for today.</p>';
    return;
  }
  
  const table = `
    <table class="time-block-table">
      <thead>
        <tr>
          <th>From</th>
          <th>To</th>
          <th>Action</th>
          <th class="check-cell">Done</th>
        </tr>
      </thead>
      <tbody>
        ${todos.map(todo => `
          <tr data-id="${todo.id}" ${todo.todo_meta.status === 'missed' ? 'class="missed"' : ''}>
            <td>${todo.todo_meta.from}</td>
            <td>${todo.todo_meta.to}</td>
            <td>${sanitize(todo.text)}</td>
            <td class="check-cell">
              <button class="toggle-todo-btn">✓</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  container.innerHTML = table;
}

async function toggleTodo(id) {
  const { data, error } = await supabase.from('entries').select('*').eq('id', id).single();
  if (error || !data) return;
  
  await supabase.from('entries').update({
    todo_meta: { ...data.todo_meta, status: 'done' }
  }).eq('id', id);
  
  showToast('Task completed!', 'success');
  await refreshAll();
}

async function renderCalendar() {
  const year = currentCalendarMonth.getFullYear();
  const month = currentCalendarMonth.getMonth();
  
  document.getElementById('calendar-month').textContent = 
    currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  
  const entries = await getEntries();
  const entriesByDate = {};
  entries.forEach(e => {
    if (!entriesByDate[e.date]) entriesByDate[e.date] = [];
    entriesByDate[e.date].push(e);
  });
  
  const grid = document.getElementById('calendar-grid');
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="calendar-day other-month"></div>';
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === getLocalDate();
    const hasEntries = entriesByDate[dateStr]?.length > 0;
    
    html += `
      <div class="calendar-day ${isToday ? 'today' : ''}" data-date="${dateStr}">
        ${day}
        ${hasEntries ? '<div style="margin-top:4px;font-size:10px;">●</div>' : ''}
      </div>
    `;
  }
  
  grid.innerHTML = html;
}

async function showDayModal(date) {
  const entries = await getEntries({ date });
  const modal = document.getElementById('day-modal');
  document.getElementById('day-modal-title').textContent = new Date(date).toLocaleDateString('en-US', { 
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
  });
  
  const content = entries.length === 0 
    ? '<p>No entries for this day.</p>'
    : entries.map(e => `
        <div class="entry">
          <div class="entry-header">
            <div class="entry-time">${formatDateTime(e.timestamp)} (${e.type})</div>
            ${e.amount ? `<div class="entry-amount ${e.type}">${formatCurrency(e.amount)}</div>` : ''}
          </div>
          <div class="entry-text">${sanitize(e.text)}</div>
        </div>
      `).join('');
  
  document.getElementById('day-modal-content').innerHTML = content;
  modal.classList.add('active');
}

async function renderGraph() {
  const period = localStorage.getItem('chartPeriod') || 'monthly';
  const entries = await getEntries();
  
  const assetData = {};
  const liabilityData = {};
  
  entries.forEach(entry => {
    if (entry.type !== 'asset' && entry.type !== 'liability') return;
    if (!entry.amount) return;
    
    const date = new Date(entry.timestamp);
    let key;
    
    if (period === 'daily') {
      key = entry.date;
    } else if (period === 'monthly') {
      key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    } else {
      key = date.getFullYear().toString();
    }
    
    if (entry.type === 'asset') {
      assetData[key] = (assetData[key] || 0) + entry.amount;
    } else {
      liabilityData[key] = (liabilityData[key] || 0) + entry.amount;
    }
  });
  
  const labels = [...new Set([...Object.keys(assetData), ...Object.keys(liabilityData)])].sort();
  
  const canvas = document.getElementById('distribution-chart');
  const ctx = canvas.getContext('2d');
  
  if (chartInstance) {
    chartInstance.destroy();
  }
  
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Assets',
          data: labels.map(l => assetData[l] || 0),
          backgroundColor: '#10b981'
        },
        {
          label: 'Liabilities',
          data: labels.map(l => liabilityData[l] || 0),
          backgroundColor: '#ef4444'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

async function signInWithGoogle() {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.origin }
  });
  
  if (error) {
    showToast('Sign in failed: ' + error.message, 'error');
  }
}

async function signOut() {
  await supabase.auth.signOut();
  showToast('Signed out', 'info');
}

function updateUIAfterAuth(user) {
  document.getElementById('google-sign-in-prompt').classList.add('hidden');
  document.getElementById('user-profile-card').classList.remove('hidden');
  document.getElementById('google-disconnect-btn').classList.remove('hidden');
  
  const avatar = user.user_metadata?.avatar_url || user.user_metadata?.picture || '';
  const name = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0];
  
  document.getElementById('user-avatar').src = avatar;
  document.getElementById('user-name').textContent = name;
  document.getElementById('user-email').textContent = user.email;
  
  document.getElementById('drive-status').classList.remove('disconnected');
  document.getElementById('drive-status').classList.add('connected');
  document.getElementById('drive-status').querySelector('span').textContent = 'Connected';
  
  document.getElementById('clear-data-btn').disabled = false;
}

function updateUIAfterSignOut() {
  document.getElementById('google-sign-in-prompt').classList.remove('hidden');
  document.getElementById('user-profile-card').classList.add('hidden');
  document.getElementById('google-disconnect-btn').classList.add('hidden');
  
  document.getElementById('drive-status').classList.remove('connected');
  document.getElementById('drive-status').classList.add('disconnected');
  document.getElementById('drive-status').querySelector('span').textContent = 'Disconnected';
  
  document.getElementById('clear-data-btn').disabled = true;
  
  ['asset', 'liability', 'diary'].forEach(type => {
    document.getElementById(`entries-${type}`).innerHTML = 
      '<div class="empty-state">Sign in to view entries</div>';
  });
}

async function exportData(format) {
  const entries = await getEntries();
  if (entries.length === 0) {
    showToast('No data to export', 'info');
    return;
  }
  
  if (format === 'json') {
    const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
    downloadBlob(blob, `alertjar-${getLocalDate()}.json`);
  } else if (format === 'csv') {
    const lines = ['ID,Type,Date,Text,Amount'];
    entries.forEach(e => {
      lines.push(`${e.id},${e.type},${e.date},"${e.text}",${e.amount || ''}`);
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
    downloadBlob(blob, `alertjar-${getLocalDate()}.csv`);
  }
  
  showToast(`Exported ${entries.length} entries`, 'success');
}

function downloadBlob(blob, filename) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function importData(file) {
  const text = await file.text();
  try {
    const entries = JSON.parse(text);
    if (!Array.isArray(entries)) throw new Error('Invalid format');
    
    for (const entry of entries) {
      await saveEntry(entry);
    }
    
    showToast(`Imported ${entries.length} entries`, 'success');
    await refreshAll();
  } catch (error) {
    showToast('Invalid JSON file', 'error');
  }
}

async function deleteAllData() {
  if (!confirm('Delete all data? This cannot be undone!')) return;
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;
  
  await supabase.from('entries').delete().eq('user_id', user.id);
  showToast('All data deleted', 'success');
  await refreshAll();
}

async function refreshAll() {
  try {
    const [assets, liabilities, diary, todos] = await Promise.all([
      getEntries({ type: 'asset' }),
      getEntries({ type: 'liability' }),
      getEntries({ type: 'diary' }),
      getEntries({ type: 'todo', date: getLocalDate() })
    ]);
    
    renderEntries('asset', assets);
    renderEntries('liability', liabilities);
    renderDiaryEntries(diary);
    renderDiaryTags(diary);
    renderTodos(todos.filter(t => t.todo_meta?.isTimeBlocked));
    await renderCalendar();
    
    if (document.getElementById('graphs-tab').classList.contains('active')) {
      await renderGraph();
    }
  } catch (error) {
    console.error('Refresh failed:', error);
  }
}

function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', newTheme);
  document.getElementById('theme-toggle').textContent = newTheme === 'dark' ? '☀️' : '🌙';
  localStorage.setItem('theme', newTheme);
  
  if (chartInstance) renderGraph();
}

document.addEventListener('DOMContentLoaded', async () => {
  await initSupabase();
  initSpeechRecognition();
  await refreshAll();
  
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? '☀️' : '🌙';
  
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
      
      if (btn.dataset.tab === 'graphs') renderGraph();
    });
  });
  
  document.querySelectorAll('.sub-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const parent = btn.closest('.card');
      parent.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
      parent.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      parent.querySelector(`#${btn.dataset.subtab}-subtab`).classList.add('active');
    });
  });
  
  document.getElementById('record-asset').addEventListener('click', () => {
    if (isRecording) stopRecording();
    else startRecording('asset');
  });
  
  document.getElementById('record-liability').addEventListener('click', () => {
    if (isRecording) stopRecording();
    else startRecording('liability');
  });
  
  document.getElementById('record-diary').addEventListener('click', () => {
    if (isRecording) stopRecording();
    else startRecording('diary');
  });
  
  document.getElementById('add-asset-btn').addEventListener('click', () => {
    addEntry('asset', document.getElementById('manual-asset').value);
  });
  
  document.getElementById('add-liability-btn').addEventListener('click', () => {
    addEntry('liability', document.getElementById('manual-liability').value);
  });
  
  document.getElementById('add-diary-btn').addEventListener('click', () => {
    addDiaryEntry(document.getElementById('manual-diary').value);
  });
  
  document.getElementById('add-todo-btn').addEventListener('click', addTodo);
  
  document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('delete-entry-btn')) {
      const entry = e.target.closest('.entry');
      if (confirm('Delete this entry?')) {
        await deleteEntry(entry.dataset.id);
        showToast('Entry deleted', 'success');
        await refreshAll();
      }
    }
    
    if (e.target.classList.contains('toggle-todo-btn')) {
      const row = e.target.closest('tr');
      await toggleTodo(row.dataset.id);
    }
  });
  
  document.getElementById('prev-month').addEventListener('click', () => {
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
    renderCalendar();
  });
  
  document.getElementById('next-month').addEventListener('click', () => {
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
    renderCalendar();
  });
  
  document.getElementById('today-btn').addEventListener('click', () => {
    currentCalendarMonth = new Date();
    renderCalendar();
  });
  
  document.addEventListener('click', (e) => {
    const day = e.target.closest('.calendar-day[data-date]');
    if (day && !day.classList.contains('other-month')) {
      showDayModal(day.dataset.date);
    }
  });
  
  document.querySelectorAll('.graph-period-selector .btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.graph-period-selector .btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      localStorage.setItem('chartPeriod', btn.dataset.period);
      renderGraph();
    });
  });
  
  document.getElementById('google-connect-btn').addEventListener('click', signInWithGoogle);
  document.getElementById('google-disconnect-btn').addEventListener('click', signOut);
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  document.getElementById('export-json').addEventListener('click', () => exportData('json'));
  document.getElementById('export-csv').addEventListener('click', () => exportData('csv'));
  document.getElementById('import-json').addEventListener('change', (e) => {
    if (e.target.files[0]) importData(e.target.files[0]);
  });
  document.getElementById('clear-data-btn').addEventListener('click', deleteAllData);
  document.getElementById('download-chart').addEventListener('click', () => {
    const canvas = document.getElementById('distribution-chart');
    canvas.toBlob(blob => downloadBlob(blob, `chart-${getLocalDate()}.png`));
  });
  
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.closest('.modal').classList.remove('active');
    });
  });
  
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });
  });
  
  document.getElementById('help-btn').addEventListener('click', () => {
    document.getElementById('help-modal').classList.add('active');
  });
  
  document.getElementById('search-diary').addEventListener('input', async (e) => {
    const search = e.target.value.toLowerCase();
    const entries = await getEntries({ type: 'diary' });
    const filtered = search ? entries.filter(e => e.text.toLowerCase().includes(search)) : entries;
    renderDiaryEntries(filtered);
  });
  
  document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('tag')) {
      const tag = e.target.dataset.tag;
      const isActive = e.target.classList.contains('active');
      
      document.querySelectorAll('#tags-diary .tag').forEach(t => t.classList.remove('active'));
      
      if (!isActive) {
        e.target.classList.add('active');
        const entries = await getEntries({ type: 'diary' });
        const filtered = entries.filter(e => e.tags?.includes(tag));
        renderDiaryEntries(filtered);
      } else {
        const entries = await getEntries({ type: 'diary' });
        renderDiaryEntries(entries);
      }
    }
  });
});
</script>
</body>
</html>
